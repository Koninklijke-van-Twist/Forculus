name: Deploy to FTP on master push

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Debug env
        run: |
          echo "Host: $FTP_HOST"
          echo "User: $FTP_USERNAME"
          # echo "Pass: $FTP_PASSWORD"  # liever niet loggen ðŸ˜‰
          echo "Remote dir: $FTP_REMOTE_DIR"
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}


      # Stap 1: alles op de server opruimen behalve .htaccess, .htpasswd, *.json, *.sqlite
      - name: Clean remote directory (preserve config & db)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_HOST" << EOF
          set cmd:fail-exit true
          set net:max-retries 1
          set net:timeout 20
          set ftp:ssl-allow false
          set ftp:passive-mode yes
          set ftp:list-options -a
      
          cd "$FTP_REMOTE_DIR"
          find . \
            -not -name . \
            -not -name .htaccess \
            -not -name .htpasswd \
            -not -name "*.json" \
            -not -name "*.sqlite" \
            -exec rm -rf {} +
          bye
          EOF


      # Stap 2: inhoud van ./web uploaden naar remote directory
      - name: Upload web/ to FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_HOST" << EOF
          set cmd:fail-exit true
          set net:max-retries 1
          set net:timeout 20
          set ftp:ssl-allow false
          set ftp:passive-mode yes
      
          cd "$FTP_REMOTE_DIR"
          mirror -R ./web .
          bye
          EOF

